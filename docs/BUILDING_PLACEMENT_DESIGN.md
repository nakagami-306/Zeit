# 建物配置システム設計

## 概要
中心から外側へ自然に拡大する円形住宅エリアシステム。住宅は既存建物の隣に優先的に配置され、密度の高いエリアを優先することで自然な集落形成をシミュレートする。

## 基本設計

### 1. 円形住宅エリア
- **中心点**: グリッドの中心 (25, 25)
- **初期半径**: 5グリッド（調整可能）
- **最大半径**: 20グリッド（40x40の範囲）
- **境界チェック**: 円の外側には建物を配置しない

### 2. 配置優先順位システム

#### 優先度計算
各空きグリッドの優先度を以下の要素で計算：

1. **隣接ボーナス** (最重要)
   - 既存建物に隣接している数（4方向）
   - 隣接数 × 10ポイント
   
2. **密度ボーナス**
   - 周囲3x3グリッド内の建物数
   - 建物数 × 2ポイント
   
3. **中心からの距離ペナルティ**
   - 中心に近いほど高優先度
   - -distance × 0.5ポイント

#### 配置アルゴリズム
```
1. 円形エリア内のすべての空きグリッドを取得
2. 各グリッドの優先度を計算
3. 最高優先度のグリッドを選択（同点の場合はランダム）
4. 建物を配置
```

### 3. 成長パターン

#### Phase 1: 核形成（人口 1-10）
- 中心付近にコンパクトに配置
- 最初の建物は中心に配置

#### Phase 2: 拡大（人口 11-50）
- 既存の集落から外側へ成長
- 複数の小集落が形成される可能性

#### Phase 3: 充填（人口 51+）
- 集落間の空きスペースを埋める
- より密集した都市形成

## 実装詳細

### GridManager の拡張

```gdscript
# 新しいプロパティ
var center_position: Vector2i = Vector2i(25, 25)
var residential_radius: float = 5.0
var max_radius: float = 20.0

# 新しいメソッド
func is_within_residential_area(position: Vector2i) -> bool:
    var distance = position.distance_to(center_position)
    return distance <= residential_radius

func get_adjacent_buildings_count(position: Vector2i) -> int:
    # 4方向の隣接建物をカウント
    
func get_area_density(position: Vector2i, radius: int = 1) -> float:
    # 指定半径内の建物密度を計算
    
func calculate_placement_priority(position: Vector2i) -> float:
    # 配置優先度を計算
    
func get_best_position() -> Vector2i:
    # 最適な配置位置を返す
```

### GameManager の変更

```gdscript
func _spawn_house():
    var best_position = grid_manager.get_best_position()
    if best_position != Vector2i(-1, -1):
        # 家を配置
        # 必要に応じて住宅エリアを拡大
```

## 住宅エリアの動的拡大

### 拡大条件
- 現在のエリア内の占有率が70%を超えた場合
- または、エリア境界付近に建物が集中した場合

### 拡大方法
- 半径を1グリッドずつ増加
- 最大半径に達するまで継続

## 視覚的フィードバック（将来的な実装）

1. **エリア境界の表示**
   - 半透明の円で住宅エリアを表示
   - デバッグモードでのみ表示

2. **密度ヒートマップ**
   - 建物密度を色で表現
   - 配置優先度の可視化

## パラメータ調整

以下のパラメータは調整可能にする：
- 初期半径
- 最大半径
- 隣接ボーナスの重み
- 密度ボーナスの重み
- 距離ペナルティの重み
- エリア拡大の閾値

## テスト計画

1. **単体テスト**
   - 円形エリア判定
   - 優先度計算
   - 最適位置選択

2. **統合テスト**
   - 自然な集落形成パターン
   - エリア拡大の動作
   - エッジケース（エリア満杯時など）

## 期待される効果

1. **より自然な街の成長**
   - 中心から外側への有機的な拡大
   - 現実的な集落パターン

2. **ゲームプレイの向上**
   - 街の成長が視覚的に理解しやすい
   - 計画的な都市形成の要素

3. **将来の拡張性**
   - 複数の住宅エリア（地区）への対応
   - 異なる建物タイプへの応用