# Zeit 開発履歴

## 2025-06-25

### プロジェクト初期化
- Godot 4.4.1プロジェクトの作成
- 基本的なディレクトリ構造の設定
- Git初期化とGitHubリポジトリへのプッシュ

### 要件定義
- ゲームコンセプト決定：スマホ依存対策型の村発展シミュレーション
- 9つの時代設定（太古〜未来）
- 3x3グリッドの建物、12x12のブロックシステム
- カメラ操作の追加（当初は固定カメラの予定だったが変更）

### 技術的な実装
#### 2Dアイソメトリック実装（第1段階）
- GridSystem.gd: グリッドベースの配置システム
- GameWorld.gd: 2Dアイソメトリック表示
- Building.gd: 建物クラス（3グレード対応）
- TimeManager.gd: 時間管理システム（AutoLoad）
- GameUI.gd: UI表示（時間、人口、時代、速度調整スライダー）

実装した機能：
- グリッドシステム（12x12ブロック、3x3建物）
- アイソメトリック座標変換
- 太古時代の住居3グレード（色分けプレースホルダー）
- 時間管理（フォアグラウンドのみ進行）
- 建設アニメーション（黄色い枠）
- カメラ移動（マウスドラッグ、WASD、画面端）

#### 3Dアイソメトリック実装への移行（第2段階）
- 2D実装で建物表示に問題があったため、3Dベースに変更
- GameWorld3D.gd: 3D空間でのアイソメトリック視点
- 正投影カメラで45度の角度から見下ろす視点
- BoxMeshを使用した簡易的な建物表現

### 今後の実装予定
1. 建物配置アルゴリズム（4方向隣接）
2. 道路自動生成（ブロック単位）
3. 建築アニメーション
4. カメラ自動調整
5. セーブ/ロード機能

## 2025-06-25 (続き)

### バグ修正
- MainシーンのタイプをNode2DからNodeに変更（3D対応）

### プロジェクトリセット
- 実装が複雑になってきたため、ゼロから作り直すことを決定
- すべてのシーン・スクリプトファイルを削除
- project.godotを基本的な設定にリセット

### MVP要件定義完了
- シンプルな人口増加と家の自動生成に特化
- 3Dアイソメトリック視点
- Kenney City Kit Industrialのアセット使用（building-i.obj）

## 2025-06-26

### MVP実装開始（mvp-1ブランチ）
- TDDアプローチで実装
- Phase 1: 基本シーン構築とテスト環境
  - test/ディレクトリ作成
  - TestRunner.gd作成（テストフレームワーク）
  - sample_test.gdでテスト出力確認
  - プロジェクト設定完了（1280x720、モバイル、空色背景）
  - メインシーン作成（TDD: RED→GREEN）
  - 3Dカメラ実装（アイソメトリック、正投影）
  - ライティング実装（DirectionalLight3D、影有効）
  - 地面実装（CSGBox3D、緑色）
  - Phase 1完了！全テスト成功
- Phase 2: GameManagerとコアシステム
  - GameManagerクラス作成（Autoload登録）
  - 人口管理システム実装（10秒ごとに1人増加）
  - 家の生成ロジック実装（3人につき1軒）
  - _calculate_required_housesメソッド実装
  - 時間管理システム実装（elapsed_time、time_scale）
  - GridManagerクラス作成（50x50グリッド）
  - グリッド占有管理機能実装
  - Phase 2完了！全テスト成功
- Phase 3: 家の実装
  - building-i.objのインポート確認
  - 家のシーン作成（house.tscn）
  - MeshInstance3DとStaticBody3D実装
  - 家の配置システム実装
  - HouseContainerノード追加
  - spawn_houseメソッド実装
  - Phase 3完了！全テスト成功
- Phase 4: UI実装
  - UIシーン作成（ui.tscn）
  - UI.gdスクリプト作成
  - 人口表示実装
  - 家の数表示実装
  - 経過時間表示実装（MM:SS/HH:MM:SS形式）
  - 時間加速スライダー実装（x1-x100）
  - メインシーンにUI追加
  - Phase 4完了！全テスト成功
- Phase 5: カメラコントロール
  - CameraController.gd作成
  - キーボード入力（WASD）実装
  - マウスドラッグ実装
  - 移動範囲制限（-15〜35）
  - Phase 5完了！全テスト成功
- Phase 6: 統合テストと最適化
  - 統合テスト作成（ゲームフロー全体）
  - パフォーマンステスト（100軒の家）
  - エッジケーステスト（グリッド満杯、極端な時間スケール）
  - MVP実装完了！

### MVP動作確認
- 全38テストが正常にパス
- 人口増加機能：10秒ごとに1人ずつ増加することを確認
- 家の自動生成：人口が3人になるごとに家が生成されることを確認
- グリッドシステム：50x50のグリッドで重複なく配置されることを確認
- カメラ操作：WASDキーとマウスドラッグで正常に動作することを確認
- UI表示：人口、家の数、経過時間、速度倍率が正しく表示されることを確認
- 時間加速：x1〜x100の速度調整が正常に機能することを確認
- フォアグラウンドのみ動作：バックグラウンドでは時間が進まないことを確認
- MVPの全要件が満たされていることを確認！

### MVP-2実装（mvp-2ブランチ）
- 円形住宅エリアシステムの実装
  - 中心(25,25)から半径5でスタートする円形エリア
  - 住宅はエリア内にのみ配置可能
- 優先度配置システムの実装
  - 隣接ボーナス：既存建物の隣を優先（重み10.0）
  - 密度ボーナス：周囲の建物密度を考慮（重み2.0）
  - 距離ペナルティ：中心から遠いほど優先度低下（重み0.5）
  - 最初の家は必ず中心に配置
- 自然な集落形成
  - 中心から外側へ有機的に拡大
  - 既存建物の隣に新規建物が配置される
- テスト追加（35個の新規テスト）
  - 円形エリア判定テスト
  - 隣接・密度計算テスト  
  - 優先度計算テスト
  - 最適位置選択テスト
  - 統合テスト
- バグ修正
  - 整数除算エラーの修正（GameManager.gd、UI.gd）
  - 住宅エリア満杯時のカウンター増加バグ修正
  - テストコードのgrid_managerアクセス方法修正
- 動的エリア拡大機能は実装したが最終的に無効化

### MVP-3実装（mvp-2ブランチ継続）
- 有機的道路生成システムの実装
  - GridManagerに道路対応追加（CellType enum: EMPTY, HOUSE, ROAD）
  - 密度ベースの道路生成アルゴリズム実装
  - A*経路探索による道路配置
  - 5軒以上の家で道路生成開始
- RoadManagerクラスの実装
  - 密度マップ計算（半径3の円形範囲）
  - ホットスポット検出（高密度エリア）
  - 主要道路生成（ホットスポット間を接続）
  - 支線道路生成（すべての家を最寄り道路に接続）
- 道路ビジュアルの実装
  - road.tscnシーン作成（MeshInstance3D）
  - 黒色（0.1, 0.1, 0.1）の平面メッシュ
  - 地面より0.05高い位置に配置
- テスト追加（8フェーズ、50以上の新規テスト）
  - グリッド道路対応テスト
  - 密度計算テスト
  - 経路探索テスト
  - 道路生成統合テスト
- デバッグと修正
  - CSGBox3DからMeshInstance3Dへの変更（表示問題対応）
  - 道路生成タイミングの確認（5軒到達時）
  - デバッグ出力の追加

